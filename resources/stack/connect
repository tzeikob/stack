#!/usr/bin/env bash

source ~/.config/stack/utils

require "networkmanager"
require "wpa_supplicant"
require "wireless_tools"

sel () {
  local OBJECT=$1
  local NAME=$2

  if [ "$OBJECT" = "device" ]; then
    SEL_DEVICE=$NAME
    SEL_CONNECTION=""
    SEL=$SEL_DEVICE
  elif [ "$OBJECT" = "connection" ]; then
    SEL_DEVICE=""
    SEL_CONNECTION=$NAME
    SEL=$SEL_CONNECTION
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

desel () {
  SEL_DEVICE=""
  SEL_CONNECTION=""
  SEL=""
}

status () {
  nmcli --colors no general status

  local OLD_IFS=$IFS && IFS=","

  local CONNECTIONS=($(
    nmcli -g DEVICE,TYPE,STATE,CONNECTION device |
      trim |
      awk -v FS=':' -v OFS=':' '{if ($3 == "connected" ) {print $4","}}' |
      no_breaks
  ))

  IFS=$OLD_IFS

  for CONNECTION in "${CONNECTIONS[@]}"; do
    echo
    nmcli --colors no --fields \
      "connection.interface-name, \
      connection.id, \
      connection.uuid, \
      connection.type, \
      connection.interface-name, \
      connection.autoconnect, \
      802-11-wireless.ssid, \
      802-11-wireless.mode, \
      802-11-wireless.band, \
      802-11-wireless.channel, \
      802-11-wireless.seen-bssids, \
      802-11-wireless-security.key-mgmt, \
      ipv4.method, \
      ipv6.method, \
      proxy.method, \
      GENERAL.STATE, \
      IP4.ADDRESS, \
      IP4.GATEWAY, \
      IP4.ROUTE, \
      IP4.DNS, \
      IP6.ADDRESS, \
      IP6.GATEWAY, \
      IP6.ROUTE" \
      connection show "$CONNECTION"
  done
}

show () {
  local OBJECT=$1
  local NAME=$2

  if [ "$OBJECT" = "device" ]; then
    nmcli --colors no device show "$NAME"
  elif [ "$OBJECT" = "connection" ]; then
    nmcli --colors no --fields \
      "connection.interface-name, \
      connection.id, \
      connection.uuid, \
      connection.type, \
      connection.interface-name, \
      connection.autoconnect, \
      802-11-wireless.ssid, \
      802-11-wireless.mode, \
      802-11-wireless.band, \
      802-11-wireless.channel, \
      802-11-wireless.seen-bssids, \
      802-11-wireless-security.key-mgmt, \
      ipv4.method, \
      ipv6.method, \
      proxy.method, \
      GENERAL.STATE, \
      IP4.ADDRESS, \
      IP4.GATEWAY, \
      IP4.ROUTE, \
      IP4.DNS, \
      IP6.ADDRESS, \
      IP6.GATEWAY, \
      IP6.ROUTE" \
      connection show "$NAME"
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

devices () {
  local TYPE=$1
  
  if [ -z "$TYPE" ]; then
    nmcli --colors no device
  else
    nmcli device | awk -v t=$TYPE '{if ($2 == t || $2 == "TYPE") {print}}'
  fi
}

connections () {
  local TYPE=$1

  if [ -z "$TYPE" ]; then
    nmcli --colors no connection
  else
    nmcli --color no connection | awk -v t=$TYPE '{if ($3 == t || $3 == "TYPE") {print}}'
  fi
}

scan () {
  local OLD_IFS=$IFS && IFS=","

  local NETWORKS=($(
    nmcli -f SIGNAL,SSID,IN-USE -t device wifi list |
      trim |
      awk -F: '{if ($3 == "*") {print "["$1"] \033[32m"$2"\033[0m,"} \
        else {print "["$1"] \033[35m"$2"\033[0m,"}}' |
      no_breaks
  ))

  IFS=$OLD_IFS

  print 3 40 "${NETWORKS[@]}"
}

up () {
  local OBJECT=$1
  local NAME=$2

  if [ "$OBJECT" = "device" ]; then
    nmcli device connect "$NAME"
  elif [ "$OBJECT" = "connection" ]; then
    nmcli connection up "$NAME"
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

down () {
  local OBJECT=$1
  local NAME=$2

  if [ "$OBJECT" = "device" ]; then
    nmcli device disconnect "$NAME"
  elif [ "$OBJECT" = "connection" ]; then
    nmcli connection down "$NAME"
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

power () {
  local OBJECT=$1
  local STATUS=${2:-"on"}

  if [ "$OBJECT" = "network" ]; then
    echo "Powering network $STATUS..."
    nmcli networking "$STATUS" &&
      sleep 6 &&
      echo "Network set to $STATUS status" ||
      echo "Unable to power $STATUS the network"
  elif [ "$OBJECT" = "wifi" ]; then
    echo "Powering wifi $STATUS..."
    nmcli radio wifi "$STATUS" &&
      sleep 6 &&
      echo "Wifi set to $STATUS status" ||
      echo "Unable to power $STATUS the wifi"
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

delete () {
  local OBJECT=$1
  local NAME=$2

  if [ "$OBJECT" = "device" ]; then
    askme "Do you want to delete the device?" "yes" "no"

    if [ "$REPLY" = "yes" ]; then
      nmcli device delete "$NAME"
      desel
    fi
  elif [ "$OBJECT" = "connection" ]; then
    askme "Do you want to delete the connection?" "yes" "no"

    if [ "$REPLY" = "yes" ]; then
      nmcli connection delete "$NAME"
      desel
    fi
  else
    echo "Unknown or invalid object: $OBJECT"
  fi
}

connect () {
  local SSID=$1
  local SECRET_KEY=$2

  nmcli device wifi connect "$SSID" password "$SECRET_KEY" hidden yes
}

help () {
  if [ -z "$SEL" ]; then
    echo "COMMANDS"
    printf " %-25s\t%s\n" \
      "status" "Show the current status of system's networking" \
      "devices [<type>]" "List all network devices or filtered by type" \
      "connections [<type>]" "List all network connections or filtered by type" \
      "scan" "Scan for wireless networks in your area" \
      "power network <on|off>" "Power on/off the system networking" \
      "power wifi <on|off>" "Power on/off the wifi" \
      "connect <SSID> <secret-key>" "Connect to a wireless network" \
      "select device <name>" "Select a device by the given name" \
      "select connection <name>" "Select a connection by the given name" \
      "help" "Show this help message"
  else
    echo "COMMANDS"
    printf " %-25s\t%s\n" \
      "help" "Show this help message" \
      "status" "Show the current status of the selected device or connection" \
      "up" "Get the selected device or connection up" \
      "down" "Get the selected device or connection down" \
      "delete" "Delete the selected device or connection" \
      "deselect" "Deselect the select device or connection"
  fi
}

while true; do
  if [ -z "$SEL" ]; then
    NETWORKING=$(nmcli networking)
    STATUS=$(nmcli -g STATE,CONNECTIVITY general status)

    FOREGROUND=$WHITE
    if [ "$NETWORKING" = "enabled" ]; then
      if [[ "$STATUS" =~ ^connected ]]; then
        FOREGROUND=$GREEN
      elif [[ "$STATUS" =~ ^disconnected ]]; then
        FOREGROUND=$RED
      else
        FOREGROUND=$YELLOW
      fi
    fi

    prompt "$STATUS" "$FOREGROUND"
  else
    prompt "$SEL" "$YELLOW"
  fi

  history -s "$REPLY"
  CMD=($(echo "$REPLY" | tr ':' '\n'))

  if [ "${CMD[0]}" = "help" ]; then
    help
    continue
  elif [ "${CMD[0]}" = "clear" ]; then
    clear
    continue
  elif [ "${CMD[0]}" = "quit" ]; then
    break
  fi

  if [ -z "$SEL" ]; then
    if [ "${CMD[0]}" = "status" ]; then
      status
    elif [ "${CMD[0]}" = "devices" ]; then
      devices "${CMD[@]:1}"
    elif [ "${CMD[0]}" = "connections" ]; then
      connections "${CMD[@]:1}"
    elif [ "${CMD[0]}" = "scan" ]; then
      scan
    elif [ "${CMD[0]}" = "power" ]; then
      power "${CMD[@]:1}"
    elif [ "${CMD[0]}" = "connect" ]; then
      connect "${CMD[@]:1}"
    elif [ "${CMD[0]}" = "select" ]; then
      if [ "${CMD[1]}" = "device" ]; then
        sel device "${CMD[*]:2}"
      elif [ "${CMD[1]}" = "connection" ]; then
        sel connection "${CMD[*]:2}"
      else
        echo "Unknown or invalid command: $REPLY"
      fi
    elif [ ! -z "$REPLY" ]; then
      echo "Unknown or invalid command: $REPLY"
    fi
  else
    if [ "${CMD[0]}" = "status" ]; then
      if [ ! -z "$SEL_DEVICE" ]; then
        show device "$SEL_DEVICE"
      elif [ ! -z "$SEL_CONNECTION" ]; then
        show connection "$SEL_CONNECTION"
      fi
    elif [ "${CMD[0]}" = "up" ]; then
      if [ ! -z "$SEL_DEVICE" ]; then
        up device "$SEL_DEVICE" 
      elif [ ! -z "$SEL_CONNECTION" ]; then
        up connection "$SEL_CONNECTION"
      fi
    elif [ "${CMD[0]}" = "down" ]; then
      if [ ! -z "$SEL_DEVICE" ]; then
        down device "$SEL_DEVICE" 
      elif [ ! -z "$SEL_CONNECTION" ]; then
        down connection "$SEL_CONNECTION"
      fi
    elif [ "${CMD[0]}" = "delete" ]; then
      if [ ! -z "$SEL_DEVICE" ]; then
        delete device "$SEL_DEVICE" 
      elif [ ! -z "$SEL_CONNECTION" ]; then
        delete connection "$SEL_CONNECTION"
      fi
    elif [ "${CMD[0]}" = "deselect" ]; then
      desel
    elif [ ! -z "$REPLY" ]; then
      echo "Unknown or invalid command: $REPLY"
    fi
  fi
done
